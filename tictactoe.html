<html>
<head>
<title>Tic-tac-toe</title>
<style>
#canvas {
   margin-left: 1em;
}
</style>
<script src="moves.js"></script>

<script>
const EMPTY = 0;
const CIRCLE = 1;
const CROSS = 2;

const CELL_SIZE_X = 100;
const CELL_SIZE_Y = 100;
const CELLS_X = 3;
const CELLS_Y = 3;
const TOTAL_CELLS = 9;

function Board() {
	var cells = [
		EMPTY, EMPTY, EMPTY,
		EMPTY, EMPTY, EMPTY,
		EMPTY, EMPTY, EMPTY
	];
	
	const winningStreaks = [
		[0,1,2], [3,4,5], [6,7,8],
		[0,3,6], [1,4,7], [2,5,8],
		[0,4,8], [2,4,6]
	];
	
	var nAvailableCells = 9;
	var winner = EMPTY;
	var onDrawCell = [];
	
	currentTurn = CROSS;
	
    function hasWinningStreak(streak, side) {
	   result = streak.every( n => cells[n] == side);
	   if (result) {
		winningCells = streak;
	   }
	   return result;
	}
	
	function isWinner(side) {
		return winningStreaks.some( streak => hasWinningStreak(streak, side) );
	}
	
	function drawCell(n, content,isWinner) {
		onDrawCell.forEach( callback => callback(n, content, isWinner) );
	}
	
	function setCell(n, content) {
		cells[n] = content;
		drawCell(n, content, false);
	}
	
	this.move = function (n) {
	    if (cells[n] != EMPTY) return;
		if (winner != EMPTY) return;
		
		setCell(n, currentTurn);
		if (isWinner(currentTurn)) {
			winner = currentTurn;
			winningCells.forEach( n => drawCell(n, winner, true) );
		}
		currentTurn = currentTurn == CROSS ? CIRCLE : CROSS;
		--nAvailableCells;
	}
	
	this.onDrawCell = function(callback) {
	   onDrawCell.push(callback)
	}
	
	this.cell = function(n) {
		return cells[n];
	}
	
	this.isGameEnded = function() {
		return winner != EMPTY || nAvailableCells == 0;
	}
}

function AutoPlayer(board) {
	function getAvailableCells() {
		availableCells = [];
		for (n=0; n<TOTAL_CELLS; ++n) {
			if (board.cell(n) == EMPTY) {
				availableCells.push(n);
			}
		}
		return availableCells;
	}
	
	this.move = function() {
		if (board.isGameEnded()) return;
		
		// move randomly into any available cell
		availableCells = getAvailableCells();
		idx = Math.floor(Math.random()*availableCells.length);
		cell = availableCells[idx];
		board.move(cell);
	}
}


function SmartPlayer(board) {
	var moves = getMoves();
	var powers = [ 1, 3, 9, 27, 81, 243, 729, 2187, 6561 ]; // powers of 3

	function boardToInt() {
		var result=0;
		for (n=0; n<TOTAL_CELLS; ++n) {
			result += board.cell(n)*powers[n];
		}
		return result;
	}

	this.move = function() {
		if (board.isGameEnded()) return;
		n = boardToInt();
		cell = moves[n];
		board.move(cell);
	}
}


function Game() {
  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext("2d");
  var board = new Board();
  var autoPlayer = new SmartPlayer(board); //new AutoPlayer(board);
  board.onDrawCell(drawCell);
  canvas.addEventListener("click", onClick, false);
  
  function line(x0,y0,x1,y1) {
	ctx.beginPath();
	ctx.moveTo(x0,y0);
	ctx.lineTo(x1,y1);
	ctx.stroke();
  }
  
  function drawLines() {
    ctx.strokeStyle = "#000000";
    ctx.lineWidth = 3;
	
    for (x=1; x<CELLS_X; ++x) {
	  line(x*CELL_SIZE_X, 0, x*CELL_SIZE_X, CELLS_Y*CELL_SIZE_Y);
    }
		
    for (y=1;y<CELLS_Y; ++y) {
      line(0, y*CELL_SIZE_Y, CELLS_X*CELL_SIZE_X, y*CELL_SIZE_Y);
	}
  }
  
  function drawCell(n, content, isWinner) {
	if (content == EMPTY) return;
	var y = Math.floor(n/CELLS_X);
	var x = n % CELLS_X;
	var x0 = Math.floor((x+0.5)*CELL_SIZE_X);
	var y0 = Math.floor((y+0.5)*CELL_SIZE_Y);
	
	if (isWinner) {
		ctx.fillStyle = "#EE2222";
		rx = (CELL_SIZE_X-4)/2;
		ry = (CELL_SIZE_Y-4)/2;
		ctx.fillRect(x0-rx, y0-ry, rx*2, ry*2);
	}
	
	r = CELL_SIZE_X*0.4;
	ctx.lineWidth = 10;
	
	if (content == CROSS) {
		line(x0-r, y0-r, x0+r, y0+r);
		line(x0-r, y0+r, x0+r, y0-r);
	}
	else {
		ctx.beginPath();
		ctx.ellipse(x0,y0,r,r,0,0,Math.PI*2);
		ctx.stroke();
	}
  }
  
  function onClick(event) {
    x = event.pageX - canvas.offsetLeft;
    y = event.pageY - canvas.offsetTop;
	cellX = Math.floor(x/CELL_SIZE_X);
	cellY = Math.floor(y/CELL_SIZE_Y);
	onClickCell(cellX, cellY);
  }
  
  function onClickCell(x,y) {
	var n = y*CELLS_X+x;
    board.move(n);
	autoPlayer.move();
  }
  
  this.draw = function() {
    drawLines();
  }
}


function onLoad() {
  new Game().draw();
}
</script>
</head>
<body onLoad="onLoad()">
<h1>Tic-tac-toe</h1>
<canvas id="canvas" width="300" height="300"></canvas>
</body>
</html>